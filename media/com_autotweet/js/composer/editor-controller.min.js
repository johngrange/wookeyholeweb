"use strict";define("editor-controller",["extlycore"],function(t){var a=function(a,r,n,s){var i=this;var u=a.editorCtrl;var l=s;var d=jQuery(".extly-body form");var o=null;var c=false;u.waiting=false;u.remainingCount=0;u.showDialog=false;i.addRequest=function(e){var t=u.description||"",a;var r,s={},o={},c=[],m=[];e.preventDefault();if(u.waiting){return}t=t.trim();if(t.length==0){u.showDialog=true;u.messageResult=false;u.messageText=n.trustAsHtml("Invalid field: Message");return}s["description"]=t;s["url"]=u.url;r=d.serializeArray();_.each(r,function(e){if(e.name=="postThis"){o["postthis"]=e.value}else if(e.name=="everGreen"){o["evergreen"]=e.value}else if(e.name=="channelchooser[]"){m.push(e.value)}else if(e.name=="unix_mhdmd"){o[e.name]=e.value}else if(e.name=="repeat_until"){o[e.name]=e.value}else if(e.name=="ref_id"){s[e.name]=e.value;o[e.name]=e.value}else if(e.name=="agenda[]"){c.push(e.value)}else if(e.name.match(/unix_mhdmd_/)||e.name=="scheduling_date"||e.name=="scheduling_time"||e.name=="postAttrs"||e.name=="selectedMenuItem"){}else{s[e.name]=e.value}});if(u.option_filter){o["option_filter"]=u.option_filter}o["agenda"]=c;o["channels"]=m;o["channels_text"]=i.getChannelsText();o["image"]="";s["autotweet_advanced_attrs"]=JSON.stringify(o);if(u.plugin=="autotweetpost"){s["taskCommand"]="applyAjaxOwnAction"}else{s["taskCommand"]="applyAjaxPluginAction"}s["ajax"]=1;if(o["unix_mhdmd"]&&o["unix_mhdmd"].length>0&&c.length>1){i.error({status:"",statusText:"Repeat Expression not allowed for more than one Agenda date."});return false}if(c.length>0&&i.hasPastDates(c)){i.error({status:"",statusText:"Agenda has dates in the past. Please, remove them."});return false}u.waiting=true;a=new l(s);a.$save(null,i.success,i.error)};i.jQueryAddRequest=function(e){i.loadReqId=null;i.addRequest(e);a.$digest()};i.jQueryAddRequestLoad=function(e){i.loadReqId=u.request_id;i.addRequest(e);a.$digest()};i.jQueryAddRequestAndRedirect=function(e){i.redirectOnSuccess=true;i.jQueryAddRequest(e)};i.getChannelsText=function(){var e=jQuery("#channelchooser option:selected"),t;t=_.reduce(e,function(e,t){var a=jQuery(t).text();if(e==""){return a}else{return e+", "+a}},"");return t};i.hasPastDates=function(e){var t=new Date,a=t.getTime()+t.getTimezoneOffset()*6e4,r=false,n=parseInt(jQuery("#Timezone_Offset").val()),s=Math.sign(n),i=Math.abs(n)/3600,u=Math.abs(n)%3600;try{_.each(e,function(e){var t,n,l=e;if(e.match(/^\d\d\d\d-\d\d-\d\d \d:\d\d/)){e=e.replace(" "," 0")}if(e.match(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d$/)){l=e.replace(" ","T")+":00"}else if(e.match(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d$/)){l=e.replace(" ","T")}if(s>=0){l=l+"+"}else{l=l+"-"}l=l+("0"+i).slice(-2)+":"+("0"+u).slice(-2);t=new Date(l);n=t.getTime()+t.getTimezoneOffset()*6e4;if(n<a){r=true}})}catch(l){r=true}return r};u.countRemaining=function(){var e,t=u.description.length;if(!_.isEmpty(u.hashtags)){t=t+1+u.hashtags.length}e="label";if(t>0&&t<=60){e="label label-success"}else if(t>60&&t<=100){e="label label-warning"}else if(t>100){e="label label-important"}u.remainingCount=t;u.remainingCountClass=e};u.menuitemlistHide=function(){var e=document.getElementById("menulist_group"),t=angular.element(e);if(t.hasClass("hide")){t.removeClass("hide")}else{t.addClass("hide")}};i.success=function(e){u.showDialog=true;u.messageResult=e.status;u.messageText=n.trustAsHtml(e.message);u.request_id=0;u.ref_id=e.hash;u.waiting=false;if(e.status&&i.redirectOnSuccess){Joomla.submitbutton("cancel")}i.redirectOnSuccess=false;if(i.loadReqId){r.$emit("editRequest",i.loadReqId);i.loadReqId=null}else{i.reset()}r.$emit("newRequest")};i.load=function(e){i.reset();u.waiting=false;u.showDialog=false;u.messageResult="success";u.messageText=n.trustAsHtml("-Loaded-");u.description=e.description;u.url=e.url;u.hashtags=e.xtform.hashtags;u.request_id=e.id;u.ref_id=e.ref_id;u.plugin=e.plugin;if(e.autotweet_advanced_attrs){r.$emit("loadAgenda",e.autotweet_advanced_attrs.agenda)}jQuery("#image_url").val(e.image_url);jRefreshPreview("","image_url");if(e.autotweet_advanced_attrs){u.fulltext=e.autotweet_advanced_attrs.fulltext;jQuery("#itemeditor_postthis").val(e.autotweet_advanced_attrs.postthis);jQuery("#itemeditor_evergreen").val(e.autotweet_advanced_attrs.evergreen);jQuery("#channelchooser").val(e.autotweet_advanced_attrs.channels).trigger("liszt:updated");jQuery("#unix_mhdmd").val(e.autotweet_advanced_attrs.unix_mhdmd);jQuery("#repeat_until").val(e.autotweet_advanced_attrs.repeat_until);u.option_filter=e.autotweet_advanced_attrs.option;t.UiHelper.resetBtnGroup("#itemeditor_postthis");t.UiHelper.resetBtnGroup("#itemeditor_evergreen")}u.countRemaining()};i.getHash=function(){var e=new Date,t;t=CryptoJS.MD5(""+e.getTime()+_.random(0,9007199254740992));t=CryptoJS.MD5(t+_.random(0,9007199254740992));t=CryptoJS.MD5(t+_.random(0,9007199254740992));return t};i.reset=function(){u.ref_id=i.getHash();u.plugin="autotweetpost";u.description="";u.url="";u.selectedMenuItem="";u.fulltext="";u.hashtags="";jQuery("#image_url").val("");jRefreshPreview("","image_url");jQuery("#image_url-image").html("");jQuery("#itemeditor_postthis").val(1);t.UiHelper.resetBtnGroup("#itemeditor_postthis");jQuery("#itemeditor_evergreen").val(2);t.UiHelper.resetBtnGroup("#itemeditor_evergreen");jQuery("#channelchooser").val([]).trigger("liszt:updated");jQuery(".cronjob-expression-form select").val("*");r.$emit("loadAgenda",[]);jQuery("#unix_mhdmd").val("");jQuery("#repeat_until").val("");u.countRemaining()};i.jQueryReset=function(e){e.preventDefault();i.reset();a.$digest()};i.error=function(e){u.showDialog=true;u.messageResult=false;u.messageText=n.trustAsHtml("Error: "+e.status+" "+e.statusText);i.redirectOnSuccess=false;u.waiting=false};i.editRequest=function(e,t){var a,r={};e.preventDefault();if(u.waiting){return}if(!t){return}r["id"]=t;r["request_id"]=t;r["taskCommand"]="readAjaxAction";r["ajax"]=1;u.waiting=true;a=new l(r);a.$get(null,i.load,i.error)};i.publishRequest=function(e,t){var a,r={};e.preventDefault();if(u.waiting){return}if(!t){return}r["id"]=t;r["request_id"]=t;r["taskCommand"]="publishAjaxAction";r["ajax"]=1;u.waiting=true;a=new l(r);a.$save(null,i.success,i.error)};i.cancelRequest=function(e,t){var a,r={};e.preventDefault();if(u.waiting){return}if(!t){return}r["id"]=t;r["request_id"]=t;r["taskCommand"]="cancelAjaxAction";r["ajax"]=1;u.waiting=true;a=new l(r);a.$save(null,i.success,i.error)};i.backtoQueueRequest=function(t,a){var r,n={};e.preventDefault();if(u.waiting){return}if(!a){return}n["id"]=a;n["request_id"]=a;n["taskCommand"]="backtoQueueAjaxAction";n["ajax"]=1;u.waiting=true;r=new l(n);r.$save(null,i.success,i.error)};i.loadUrl=function(e){var t,a={};if(u.waiting){return}a["itemId"]=e;a["taskCommand"]="routeAjaxItemId";a["ajax"]=1;u.waiting=true;t=new l(a);t.$save(null,i.successRoute,i.error)};i.successRoute=function(e){u.url=e.url;u.waiting=false};r.$on("editRequest",i.editRequest);r.$on("publishRequest",i.publishRequest);r.$on("cancelRequest",i.cancelRequest);r.$on("backtoQueueRequest",i.backtoQueueRequest);jQuery("#toolbar-apply button").attr("onclick",null).click(i.jQueryAddRequestLoad);jQuery("#toolbar-save button").attr("onclick",null).click(i.jQueryAddRequestAndRedirect);jQuery("#toolbar-save-new button").attr("onclick",null).click(i.jQueryAddRequest);jQuery("#F0FHeaderHolder button:nth-of-type(1)").attr("onclick",null).click(i.jQueryAddRequestLoad);jQuery("#F0FHeaderHolder button:nth-of-type(2)").attr("onclick",null).click(i.jQueryAddRequestAndRedirect);jQuery("#F0FHeaderHolder button:nth-of-type(3)").attr("onclick",null).click(i.jQueryAddRequest);jQuery("#toolbar-apply a").attr("onclick",null).click(i.jQueryAddRequestLoad);jQuery("#toolbar-save a").attr("onclick",null).click(i.jQueryAddRequestAndRedirect);jQuery("#toolbar-save-new a").attr("onclick",null).click(i.jQueryAddRequest)};a.$inject=["$scope","$rootScope","$sce","Request"];return a});
